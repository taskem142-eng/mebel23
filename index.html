<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мебель на Кубани — Каталог</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        .sidebar { background: #fff; border-right: 1px solid #dee2e6; height: 100vh; overflow-y: auto; position: sticky; top: 0; padding: 20px; }
        .cat-item { cursor: pointer; padding: 8px 12px; border-radius: 6px; color: #495057; text-decoration: none; display: block; font-size: 0.9rem; }
        .cat-item:hover { background: #e9ecef; }
        .cat-item.active { background: #0088cc; color: #fff; font-weight: bold; }
        .product-card { border: none; border-radius: 12px; height: 100%; display: flex; flex-direction: column; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .img-container { height: 180px; display: flex; align-items: center; justify-content: center; padding: 10px; }
        .img-container img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .price-tag { font-size: 1.2rem; font-weight: 800; color: #0088cc; }
        [v-cloak] { display: none; }
    </style>
</head>
<body>
<div id="app" v-cloak class="container-fluid">
    <div class="row">
        <nav class="col-md-3 col-lg-2 d-none d-md-block sidebar">
            <h5 class="fw-bold mb-3">Поиск</h5>
            <input v-model="search" type="text" class="form-control mb-4" placeholder="Название...">
            
            <h5 class="fw-bold mb-3">Цена (₽)</h5>
            <div class="d-flex gap-2 mb-4">
                <input type="number" v-model.number="minPrice" class="form-control form-control-sm" placeholder="От">
                <input type="number" v-model.number="maxPrice" class="form-control form-control-sm" placeholder="До">
            </div>

            <hr>
            <h5 class="fw-bold mb-3">Категории</h5>
            <div class="cat-item mb-2" :class="{active: !selectedCat}" @click="selectedCat = null">Все товары</div>
            <div v-for="cat in mainCategories" :key="cat.id">
                <div class="cat-item fw-bold" @click="selectedCat = cat.id" :class="{active: selectedCat == cat.id}">{{ cat.name }}</div>
                <div v-for="sub in getSubCats(cat.id)" :key="sub.id" class="cat-item ps-4 small" @click="selectedCat = sub.id" :class="{active: selectedCat == sub.id}">{{ sub.name }}</div>
            </div>
        </nav>

        <main class="col-md-9 col-lg-10 p-4">
            <div v-if="loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Загрузка каталога (1932 товара)...</p>
            </div>
            
            <div v-else>
                <h1 class="h4 fw-bold mb-4">Найдено: {{ filteredProducts.length }}</h1>
                <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4">
                    <div class="col" v-for="p in filteredProducts" :key="p.id">
                        <div class="card product-card">
                            <div class="img-container">
                                <img :src="p.image" :alt="p.name">
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h6 class="card-title" style="height: 2.5rem; overflow: hidden; font-size: 0.85rem;">{{ p.name }}</h6>
                                <div class="mt-auto">
                                    <p class="price-tag mb-2">{{ parseInt(p.price).toLocaleString() }} ₽</p>
                                    <a :href="'product/' + p.id + '.html'" class="btn btn-primary btn-sm w-100 mb-2">Подробнее</a>
                                    <a :href="'https://t.me/+79002730150?text=Заказ: ' + encodeURIComponent(p.name)" target="_blank" class="btn btn-outline-info btn-sm w-100">Telegram</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;
    createApp({
        setup() {
            const products = ref([]);
            const categories = ref([]);
            const search = ref('');
            const selectedCat = ref(null);
            const minPrice = ref(null);
            const maxPrice = ref(null);
            const loading = ref(true);

            onMounted(async () => {
                try {
                    const res = await fetch('products.json');
                    if (!res.ok) throw new Error('Файл products.json не найден');
                    const data = await res.json();
                    products.value = data.products;
                    categories.value = data.categories;
                } catch (e) {
                    alert('Ошибка загрузки данных! Убедитесь, что файл products.json лежит рядом с index.html');
                } finally {
                    loading.value = false;
                }
            });

            const mainCategories = computed(() => categories.value.filter(c => !c.parentId));
            const getSubCats = (pid) => categories.value.filter(c => c.parentId === pid);
            const filteredProducts = computed(() => {
                return products.value.filter(p => {
                    const mSearch = p.name.toLowerCase().includes(search.value.toLowerCase());
                    const mCat = !selectedCat.value || p.categoryId == selectedCat.value;
                    const mMin = !minPrice.value || parseInt(p.price) >= minPrice.value;
                    const mMax = !maxPrice.value || parseInt(p.price) <= maxPrice.value;
                    return mSearch && mCat && mMin && mMax;
                });
            });

            return { products, categories, search, selectedCat, mainCategories, getSubCats, filteredProducts, minPrice, maxPrice, loading };
        }
    }).mount('#app');
</script>
</body>
</html>